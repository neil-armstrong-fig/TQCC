---
// Unit toggle component for switching between miles and kilometers
---

<div class="flex items-center gap-2">
  <button
    class="unit-toggle-container inline-flex items-center bg-white/10 rounded-full p-1 gap-0.5 cursor-pointer hover:bg-white/15 transition-colors duration-200"
    role="group"
    aria-label="Toggle distance unit"
  >
    <div
      class="unit-toggle-label px-4 py-2 rounded-full text-sm font-medium transition-all duration-200"
      data-unit="miles"
    >
      miles
    </div>
    <div
      class="unit-toggle-label px-4 py-2 rounded-full text-sm font-medium transition-all duration-200"
      data-unit="km"
    >
      km
    </div>
  </button>
</div>

<script>
  import { getPreferredUnit, setPreferredUnit, type DistanceUnit } from "../../lib/units";

  function initUnitToggles() {
    // Find all toggle containers on the page
    const containers = document.querySelectorAll(".unit-toggle-container");

    containers.forEach((container) => {
      const labels = container.querySelectorAll(".unit-toggle-label");
      const milesLabel = Array.from(labels).find(label => label.getAttribute("data-unit") === "miles");
      const kmLabel = Array.from(labels).find(label => label.getAttribute("data-unit") === "km");

      if (!milesLabel || !kmLabel) return;

      // Update label styles based on active unit
      function updateLabelStyles(activeUnit: DistanceUnit) {
        const baseClasses = "px-4 py-2 rounded-full text-sm font-medium transition-all duration-200";
        const activeClasses = "bg-tqcc-yellow text-tqcc-black shadow-lg";
        const inactiveClasses = "text-white";

        if (activeUnit === "miles") {
          milesLabel.className = `unit-toggle-label ${baseClasses} ${activeClasses}`;
          kmLabel.className = `unit-toggle-label ${baseClasses} ${inactiveClasses}`;
        } else {
          kmLabel.className = `unit-toggle-label ${baseClasses} ${activeClasses}`;
          milesLabel.className = `unit-toggle-label ${baseClasses} ${inactiveClasses}`;
        }
      }

      // Function to update all toggles on the page
      function updateAllToggles(unit: DistanceUnit) {
        const allContainers = document.querySelectorAll(".unit-toggle-container");
        allContainers.forEach((c) => {
          const lbls = c.querySelectorAll(".unit-toggle-label");
          const mLabel = Array.from(lbls).find(label => label.getAttribute("data-unit") === "miles");
          const kLabel = Array.from(lbls).find(label => label.getAttribute("data-unit") === "km");

          if (!mLabel || !kLabel) return;

          const baseClasses = "px-4 py-2 rounded-full text-sm font-medium transition-all duration-200";
          const activeClasses = "bg-tqcc-yellow text-tqcc-black shadow-lg";
          const inactiveClasses = "text-white";

          if (unit === "miles") {
            mLabel.className = `unit-toggle-label ${baseClasses} ${activeClasses}`;
            kLabel.className = `unit-toggle-label ${baseClasses} ${inactiveClasses}`;
          } else {
            kLabel.className = `unit-toggle-label ${baseClasses} ${activeClasses}`;
            mLabel.className = `unit-toggle-label ${baseClasses} ${inactiveClasses}`;
          }
        });
      }

      // Set initial state
      const currentUnit = getPreferredUnit();
      updateLabelStyles(currentUnit);

      // Add click handler to entire container - clicking anywhere toggles the unit
      container.addEventListener("click", () => {
        const current = getPreferredUnit();
        const newUnit: DistanceUnit = current === "miles" ? "km" : "miles";
        setPreferredUnit(newUnit);
        updateAllToggles(newUnit);
      });
    });
  }

  // Initialize on page load
  document.addEventListener("astro:page-load", initUnitToggles);
</script>
