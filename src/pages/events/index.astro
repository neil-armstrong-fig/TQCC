---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import EventCard from "../../components/events/EventCard.astro";
import type { CollectionEntry } from "astro:content";

const now = new Date();
const allEvents = await getCollection("events");

const upcoming = allEvents
  .filter((e) => e.data.date >= now)
  .sort((a, b) => a.data.date.valueOf() - b.data.date.valueOf());

const past = allEvents
  .filter((e) => e.data.date < now)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Group events by month
function groupByMonth(events: CollectionEntry<"events">[]) {
  const groups: Record<string, CollectionEntry<"events">[]> = {};

  events.forEach((event) => {
    const monthYear = event.data.date.toLocaleDateString("en-GB", {
      month: "long",
      year: "numeric",
    });

    if (!groups[monthYear]) {
      groups[monthYear] = [];
    }
    groups[monthYear].push(event);
  });

  return groups;
}

const upcomingByMonth = groupByMonth(upcoming);
const pastByMonth = groupByMonth(past);
---

<BaseLayout
  title="Events"
  description="Upcoming cycling events and past event results from TQCC"
>
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4">
      <h1 class="text-4xl font-bold mb-2">Events</h1>
      <p class="text-tqcc-gray mb-8">
        Sportives, social rides, races, and more from TQCC
      </p>

      {
        upcoming.length > 0 ? (
          <div class="space-y-12">
            {Object.entries(upcomingByMonth).map(([monthYear, events]) => (
              <div>
                <h2 class="text-2xl font-bold text-tqcc-black mb-6">{monthYear}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  {events.map((event) => (
                    <EventCard event={event} />
                  ))}
                </div>
              </div>
            ))}
          </div>
        ) : (
          <div class="bg-tqcc-gray-light rounded-lg p-8 text-center">
            <p class="text-tqcc-gray text-lg">
              No upcoming events scheduled. Check back soon!
            </p>
          </div>
        )
      }

      {
        past.length > 0 && (
          <div class="mt-16">
            <h2 class="text-3xl font-bold mb-8">Past Events</h2>
            <div class="space-y-12">
              {Object.entries(pastByMonth).map(([monthYear, events]) => (
                <div>
                  <h3 class="text-2xl font-bold text-tqcc-black mb-6">{monthYear}</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    {events.map((event) => (
                      <EventCard event={event} isPast />
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )
      }
    </div>
  </section>
</BaseLayout>
