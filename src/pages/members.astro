---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const paceGroups = await getCollection("paceGroups");
const sortedGroups = paceGroups.sort((a, b) => a.data.order - b.data.order);
---

<BaseLayout
  title="Members"
  description="Members-only area for Titanic Quarter Cycling Club."
>
  <section class="py-12">
    <div class="max-w-4xl mx-auto px-4">
      <!-- Password gate -->
      <div id="password-gate" class="text-center py-20">
        <h1 class="text-4xl font-bold mb-4">Members Area</h1>
        <p class="text-tqcc-gray mb-8">
          Enter the club password to access this page.
        </p>
        <form id="password-form" class="max-w-sm mx-auto">
          <input
            type="password"
            id="password-input"
            placeholder="Password"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-lg focus:outline-none focus:ring-2 focus:ring-tqcc-yellow"
          />
          <button
            type="submit"
            class="mt-4 w-full bg-tqcc-yellow text-tqcc-black font-bold px-6 py-3 rounded-lg hover:bg-tqcc-yellow-dark transition-colors"
          >
            Enter
          </button>
          <p id="error-message" class="mt-3 text-red-500 text-sm hidden">
            Incorrect password. Please try again.
          </p>
        </form>
      </div>

      <!-- Protected content (hidden until authenticated) -->
      <div id="members-content" class="hidden">
        <h1 class="text-4xl font-bold mb-8">Members Area</h1>

        <div class="prose prose-lg max-w-none mb-12">
          <p class="text-xl text-tqcc-gray leading-relaxed">
            Welcome to the TQCC members-only area. Browse our curated routes by
            pace group below.
          </p>
        </div>

        <!-- Route Picker by Pace Group -->
        <div class="space-y-12">
          {
            sortedGroups.map((group) => (
              <div class="border border-gray-200 rounded-lg p-6 bg-white shadow-sm">
                <div class="mb-6">
                  <h2 class="text-3xl font-bold mb-2">{group.data.name}</h2>
                  <p class="text-tqcc-gray text-lg pace-string" data-pace-description={group.data.description}>
                    {group.data.description}
                  </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {group.data.routes.map((route) => (
                    <a
                      href={route.stravaUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block border border-gray-200 rounded-lg p-4 hover:border-tqcc-yellow hover:shadow-md transition-all bg-gray-50"
                    >
                      <div class="flex items-start justify-between mb-2">
                        <h3 class="font-bold text-lg text-tqcc-black">
                          {route.name}
                        </h3>
                        <span class="text-tqcc-yellow font-bold text-sm whitespace-nowrap ml-2">
                          <span class="distance-string" data-distance={`${route.distance} miles`}>
                            {route.distance} mi
                          </span>
                        </span>
                      </div>
                      {route.description && (
                        <p class="text-sm text-tqcc-gray mb-3">
                          {route.description}
                        </p>
                      )}
                      <div class="flex items-center text-sm text-tqcc-pink font-semibold">
                        View on Strava →
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  // Simple hash of the password for basic comparison.
  // This is NOT cryptographically secure — it's just casual gating.
  // The password is "tqcc" — change the hash below if you change it.
  async function hashPassword(password: string): Promise<string> {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const buffer = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(buffer))
      .map((b) => b.toString(16).padStart(2, "0"))
      .join("");
  }

  // SHA-256 hash of "tqcc-members-area"
  const EXPECTED_HASH =
    "ad4dd7d984c27ec37aa7a0dd231af79029679fb61a7a15cfb57204f316398358";
  const STORAGE_KEY = "tqcc-members-auth";

  const gate = document.getElementById("password-gate")!;
  const content = document.getElementById("members-content")!;
  const form = document.getElementById("password-form")!;
  const input = document.getElementById("password-input") as HTMLInputElement;
  const error = document.getElementById("error-message")!;

  function unlock() {
    gate.classList.add("hidden");
    content.classList.remove("hidden");
  }

  // Check if already authenticated this session
  if (sessionStorage.getItem(STORAGE_KEY) === "true") {
    unlock();
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const hash = await hashPassword(input.value.trim().toLowerCase());
    if (hash === EXPECTED_HASH) {
      sessionStorage.setItem(STORAGE_KEY, "true");
      unlock();
    } else {
      error.classList.remove("hidden");
      input.value = "";
      input.focus();
    }
  });
</script>
